var l=class{rules={};userId="";eventHistory=[];userProperties={};deviceProperties={};lastFetched=0;cdnBaseUrl="";pointerUrl="";autoRefresh=!0;pollInterval=432e5;lastFetchTime=0;currentHash="";isFetchInProgress=!1;THREADING_THRESHOLD_KB=500;companyId="";tenantId="";env="prod";apiKey="";refreshInterval=null;sessionTimeout=null;lastActivity=Date.now();sessionActive=!1;sessionTimeoutMs=1800*1e3;currentScreen="";debugMode=!1;maxEvents=5e3;maxEventAgeDays=7;eventSaveDebounceTimeout=null;eventsSavedCount=0;timeDecayIntervalId=null;onReadyCallback;onRulesUpdatedCallback;featureListeners=new Map;features=new Map;eventToFeaturesIndex=new Map;userPropertyToFeaturesIndex=new Map;devicePropertyToFeaturesIndex=new Map;featureToRulesIndex=new Map;log(e,t){if(e==="WARN"||e==="ERROR"){e==="ERROR"?console.error(`[AppFig] ${t}`):console.warn(`[AppFig] ${t}`);return}this.debugMode&&console.log(e==="INFO"?`[AppFig] ${t}`:`[AppFig:Debug] ${t}`)}async init(e){this.userId=e.userId,this.companyId=e.companyId,this.tenantId=e.tenantId,this.env=e.env,this.apiKey=e.apiKey,e.autoRefresh!==void 0?this.autoRefresh=e.autoRefresh:e.autoUpdate!==void 0?(this.autoRefresh=e.autoUpdate,this.log("WARN","autoUpdate is deprecated, use autoRefresh instead")):this.autoRefresh=!0,this.pollInterval=e.pollInterval??432e5,this.debugMode=e.debugMode??!1,this.onReadyCallback=e.onReady,this.onRulesUpdatedCallback=e.onRulesUpdated,this.sessionTimeoutMs=e.sessionTimeoutMs??1800*1e3;let t=6e4,i=72e5;(this.sessionTimeoutMs<t||this.sessionTimeoutMs>i)&&(this.log("WARN",`Session timeout ${this.sessionTimeoutMs}ms out of range. Clamping to ${t}-${i}ms`),this.sessionTimeoutMs=Math.max(t,Math.min(i,this.sessionTimeoutMs))),this.cdnBaseUrl="https://rules-prod.appfig.com",this.pointerUrl=`${this.cdnBaseUrl}/rules_versions/${e.companyId}/${e.tenantId}/${e.env}/current/latest.json`;let r=6e4,s=864e5;(this.pollInterval<r||this.pollInterval>s)&&(this.log("WARN",`Poll interval ${this.pollInterval}ms out of range. Clamping to ${r}-${s}ms`),this.pollInterval=Math.max(r,Math.min(s,this.pollInterval))),this.maxEvents=e.maxEvents??5e3,this.maxEventAgeDays=e.maxEventAgeDays??7;let n=100,a=1e5,c=1,o=365;(this.maxEvents<n||this.maxEvents>a)&&(this.log("WARN",`maxEvents ${this.maxEvents} out of range. Clamping to ${n}-${a}`),this.maxEvents=Math.max(n,Math.min(a,this.maxEvents))),(this.maxEventAgeDays<c||this.maxEventAgeDays>o)&&(this.log("WARN",`maxEventAgeDays ${this.maxEventAgeDays} out of range. Clamping to ${c}-${o}`),this.maxEventAgeDays=Math.max(c,Math.min(o,this.maxEventAgeDays))),this.maxEvents>1e4&&this.log("WARN",`Large event limit (${this.maxEvents}) may impact memory and storage on mobile devices.`),await this.loadCachedEvents();let h=this.detectPlatform(),u=this.detectLanguage(),p=this.detectTimezone(),d=this.detectOSVersion(),v=this.detectDeviceBrand(),f=this.detectDeviceModel();this.deviceProperties={platform:h,language:u,timezone:p,os_version:d,device_brand:v,device_model:f},await this.loadCachedRules(),await this.pollRules(),this.autoRefresh&&(this.log("INFO","Initializing AppFig"),this.startAutoRefresh()),e.rulesOverride&&(this.log("INFO","Local mode active"),this.rules=e.rulesOverride),this.initSessionTracking(),this.initSchemaDiscovery(),this.startTimeDecayLoop(),this.log("INFO","SDK ready")}logEvent(e,t){let i={name:e,params:t,timestamp:Date.now()};this.eventHistory.push(i),this.trackEventSchema(e,t),this.enforceEventRetention(),this.debounceSaveEvents(),this.evaluateAllFeatures()}getConfig(e){return this.shouldPoll()&&(this.log("INFO","Fetching latest rules"),this.pollRules().catch(t=>{this.log("WARN","Failed to fetch remote rules \u2013 using cached version")})),this.features.has(e)?this.features.get(e):null}setUserProperties(e){this.userProperties={...this.userProperties,...e},this.trackUserPropertySchema(e),this.evaluateAllFeatures()}setDeviceProperties(e){this.deviceProperties={...this.deviceProperties,...e},this.trackDevicePropertySchema(e),this.evaluateAllFeatures()}setAppVersion(e){this.deviceProperties={...this.deviceProperties,app_version:e},this.evaluateAllFeatures()}resetFeature(e){if(Object.keys(this.rules).length===0){this.log("WARN","Cannot reset feature: No rules loaded");return}this.log("DEBUG",`Resetting feature: ${e}`);let t=this.features.get(e);this.features.delete(e);let i=this.featureToRulesIndex.get(e);if(!i){this.features.set(e,null),this.log("DEBUG",`Feature value after reset: ${e} = null (no rules)`);return}let r=null;for(let s of i)if(this.evaluateConditions(s.conditions)){r=s.value??"on";break}this.features.set(e,r),t!==r?(this.log("DEBUG",`Feature value changed after reset: ${e} = ${r}`),this.notifyListeners(new Set([e]))):this.log("DEBUG",`Feature value unchanged after reset: ${e} = ${r}`)}resetAllFeatures(){if(Object.keys(this.rules).length===0){this.log("WARN","Cannot reset features: No rules loaded");return}this.log("DEBUG","Resetting all features"),this.features.clear(),this.evaluateAllFeatures(),this.log("DEBUG","All features reset and re-evaluated")}async detectAndSetCountry(){try{let e=new AbortController,t=setTimeout(()=>e.abort(),5e3),i=await fetch("https://rules-dev.appfig.com/rules_versions/country/country/dev/current/latest.json",{signal:e.signal});if(clearTimeout(t),!i.ok)return null;let r=i.headers.get("Country");return r?(this.setDeviceProperties({country:r}),r):null}catch{return null}}getEventHistory(){return this.eventHistory}getDebugInfo(){return{rules:this.rules,events:this.eventHistory,userProperties:this.userProperties,deviceProperties:this.deviceProperties,features:Object.fromEntries(this.features)}}startAutoRefresh(){if(this.refreshInterval&&(clearInterval(this.refreshInterval),this.refreshInterval=null),this.autoRefresh&&this.pollInterval>0){let e=this.pollInterval*(.9+Math.random()*.2);this.refreshInterval=setInterval(()=>{this.pollRules()},e)}}stopAutoRefresh(){this.refreshInterval&&(clearInterval(this.refreshInterval),this.refreshInterval=null),this.timeDecayIntervalId&&(clearInterval(this.timeDecayIntervalId),this.timeDecayIntervalId=null),this.stopSessionTracking(),this.currentScreen=""}startTimeDecayLoop(){this.timeDecayIntervalId&&clearInterval(this.timeDecayIntervalId),this.timeDecayIntervalId=setInterval(()=>{this.pruneOldEvents()>0&&this.evaluateAllFeatures()},6e4)}pruneOldEvents(){let t=Date.now()-this.maxEventAgeDays*24*60*60*1e3,i=this.eventHistory.length;this.eventHistory=this.eventHistory.filter(s=>s.timestamp>=t);let r=i-this.eventHistory.length;return r>0&&this.log("DEBUG","Event retention limit reached, pruning old events"),r}async refreshRules(){await this.pollRules()}buildIndex(){this.eventToFeaturesIndex.clear(),this.userPropertyToFeaturesIndex.clear(),this.devicePropertyToFeaturesIndex.clear(),this.featureToRulesIndex.clear();let e=0,t=0,i=0;for(let[r,s]of Object.entries(this.rules)){this.featureToRulesIndex.set(r,s);for(let n of s){let a=n.conditions,c=a.events;Array.isArray(c)?c.forEach(o=>{this.eventToFeaturesIndex.has(o.key)||this.eventToFeaturesIndex.set(o.key,new Set),this.eventToFeaturesIndex.get(o.key).add(r),e++}):c?.events&&c.events.forEach(o=>{this.eventToFeaturesIndex.has(o.key)||this.eventToFeaturesIndex.set(o.key,new Set),this.eventToFeaturesIndex.get(o.key).add(r),e++}),a.user_properties&&a.user_properties.forEach(o=>{this.userPropertyToFeaturesIndex.has(o.key)||this.userPropertyToFeaturesIndex.set(o.key,new Set),this.userPropertyToFeaturesIndex.get(o.key).add(r),t++}),a.device&&a.device.forEach(o=>{this.devicePropertyToFeaturesIndex.has(o.key)||this.devicePropertyToFeaturesIndex.set(o.key,new Set),this.devicePropertyToFeaturesIndex.get(o.key).add(r),i++})}}}evaluateAllFeatures(){if(this.featureToRulesIndex.size!==0){for(let[e,t]of this.featureToRulesIndex.entries()){let i=this.features.get(e),r=null;for(let s of t)if(this.ruleMatches(s)){r=s.value;break}if(this.features.set(e,r),i!==r){this.log("DEBUG",`Feature updated: ${e} = ${r}`);let s=this.featureListeners.get(e);s&&s.forEach(n=>n(e,r))}}for(let e of this.features.keys())this.featureToRulesIndex.has(e)||this.features.delete(e)}}shouldPoll(){return this.autoRefresh&&!this.isFetchInProgress&&Date.now()-this.lastFetchTime>this.pollInterval}async pollRules(){if(!this.isFetchInProgress){this.isFetchInProgress=!0,this.lastFetchTime=Date.now();try{let e=await fetch(this.pointerUrl,{cache:"no-store"});if(!e.ok)throw new Error(`Failed to fetch pointer: ${e.status}`);let t=e.headers.get("Country");t&&(this.deviceProperties={...this.deviceProperties,country:t},sessionStorage.setItem("appfig_country",t));let i=await e.json(),r=i.version;if(!r)throw new Error("Invalid pointer data (missing version)");if(i.min_poll_interval_secs){let c=i.min_poll_interval_secs*1e3;this.pollInterval<c&&(this.pollInterval=c)}if(this.currentHash&&this.currentHash===r){this.log("INFO","Rules are up to date"),await this.saveCacheTimestamp(),this.buildIndex(),this.evaluateAllFeatures(),this.onReadyCallback?.(),this.isFetchInProgress=!1;return}this.log("INFO","Rules updated from server");let s=`${this.cdnBaseUrl}/rules_versions/${this.companyId}/${this.tenantId}/${this.env}/current/${r}.json`,n=await fetch(s);if(!n.ok)throw new Error(`Failed to fetch immutable rules: ${n.status}`);let a=await n.json();this.rules=a.features,this.currentHash=r,await this.saveCachedRules(a,r),this.buildIndex(),this.evaluateAllFeatures(),this.onRulesUpdatedCallback?.()}catch{this.log("WARN","Failed to fetch remote rules \u2013 using cached version"),Object.keys(this.rules).length>0}finally{this.isFetchInProgress=!1}}}async detectCountryFromCDN(){try{let e=sessionStorage.getItem("appfig_country");if(e){this.deviceProperties={country:e};return}let t=new AbortController,i=setTimeout(()=>t.abort(),5e3),r=await fetch("https://rules-dev.appfig.com/rules_versions/country/country/dev/current/latest.json",{signal:t.signal,cache:"no-store"});if(clearTimeout(i),r.ok){let s=r.headers.get("Country");if(s){this.deviceProperties={country:s},sessionStorage.setItem("appfig_country",s);return}}}catch{}}async loadCachedRules(){try{let i=(await this.openIndexedDB()).transaction("rules","readonly").objectStore("rules"),r=`${this.companyId}_${this.tenantId}_${this.env}`,s=await this.idbGet(i,r);if(!s)return!1;let n=new Date(s.timestamp);this.lastFetchTime=n.getTime(),this.currentHash=s.hash||"",this.rules=s.rules||{};let a=(Date.now()-n.getTime())/6e4;return this.log("INFO","Rules loaded from cache"),!0}catch{return!1}}async saveCachedRules(e,t){try{let s=(await this.openIndexedDB()).transaction("rules","readwrite").objectStore("rules"),a={key:`${this.companyId}_${this.tenantId}_${this.env}`,rules:e.features||e,hash:t,timestamp:new Date().toISOString(),version:e.version||""};await this.idbPut(s,a)}catch{}}async saveCacheTimestamp(){try{let i=(await this.openIndexedDB()).transaction("rules","readwrite").objectStore("rules"),r=`${this.companyId}_${this.tenantId}_${this.env}`,s=await this.idbGet(i,r);s&&(s.timestamp=new Date().toISOString(),await this.idbPut(i,s))}catch{}}async openIndexedDB(){return new Promise((e,t)=>{let i=indexedDB.open("appfig-cache",2);i.onerror=()=>t(i.error),i.onsuccess=()=>e(i.result),i.onupgradeneeded=r=>{let s=r.target.result;s.objectStoreNames.contains("rules")||s.createObjectStore("rules",{keyPath:"key"}),s.objectStoreNames.contains("events")||s.createObjectStore("events",{keyPath:"key"})}})}idbGet(e,t){return new Promise((i,r)=>{let s=e.get(t);s.onerror=()=>r(s.error),s.onsuccess=()=>i(s.result)})}idbPut(e,t){return new Promise((i,r)=>{let s=e.put(t);s.onerror=()=>r(s.error),s.onsuccess=()=>i()})}async clearCache(){try{let i=(await this.openIndexedDB()).transaction("rules","readwrite").objectStore("rules"),r=`${this.companyId}_${this.tenantId}_${this.env}`;await new Promise((s,n)=>{let a=i.delete(r);a.onerror=()=>n(a.error),a.onsuccess=()=>s()})}catch{}}async loadCachedEvents(){try{let i=(await this.openIndexedDB()).transaction("events","readonly").objectStore("events"),r=`${this.companyId}_${this.tenantId}_${this.env}`,s=await this.idbGet(i,r);s&&s.events&&(this.eventHistory=s.events)}catch{}}debounceSaveEvents(){if(this.eventSaveDebounceTimeout&&clearTimeout(this.eventSaveDebounceTimeout),this.eventsSavedCount++,this.eventsSavedCount>=10){this.eventsSavedCount=0,this.saveCachedEvents();return}this.eventSaveDebounceTimeout=setTimeout(()=>{this.eventsSavedCount=0,this.saveCachedEvents()},5e3)}async saveCachedEvents(){try{let i=(await this.openIndexedDB()).transaction("events","readwrite").objectStore("events"),s={key:`${this.companyId}_${this.tenantId}_${this.env}`,events:this.eventHistory,timestamp:new Date().toISOString()};await this.idbPut(i,s)}catch{}}enforceEventRetention(){let e=this.maxEventAgeDays*24*60*60*1e3,t=Date.now()-e,i=this.eventHistory.length;this.eventHistory=this.eventHistory.filter(s=>s.timestamp>=t);let r=i-this.eventHistory.length;if(this.eventHistory.length>this.maxEvents){let s=this.eventHistory.length-this.maxEvents;this.eventHistory=this.eventHistory.slice(-this.maxEvents)}r>0}async clearEventHistory(){this.eventHistory=[],await this.saveCachedEvents(),this.evaluateAllFeatures()}getEventHistoryStats(){let e=this.eventHistory.length,t=e>0?this.eventHistory[0].timestamp:null,i=e>0?this.eventHistory[e-1].timestamp:null,r=new Blob([JSON.stringify(this.eventHistory)]).size/(1024*1024);return{count:e,oldestEvent:t,newestEvent:i,sizeMB:r}}detectPlatform(){let e=navigator.userAgent.toLowerCase(),t=navigator.platform?.toLowerCase()||"";return/iphone|ipod/.test(e)?"iOS":/ipad/.test(e)?"iPadOS":/android/.test(e)?"Android":/mac/.test(t)||/mac/.test(e)?"macOS":/win/.test(t)||/windows/.test(e)?"Windows":/linux/.test(t)||/linux/.test(e)?"Linux":/cros/.test(e)?"ChromeOS":/firefox/.test(e)&&/mobile/.test(e)?"Firefox OS":"Unknown"}detectLanguage(){return navigator.language||navigator.languages?.[0]||"en"}detectTimezone(){try{return Intl.DateTimeFormat().resolvedOptions().timeZone}catch{return"UTC"}}detectOSVersion(){let e=navigator.userAgent,t=e.match(/OS (\d+_\d+_?\d*)/);if(t)return t[1].replace(/_/g,".");let i=e.match(/Android (\d+\.?\d*\.?\d*)/);if(i)return i[1];let r=e.match(/Windows NT (\d+\.\d+)/);if(r){let n=r[1];return{"10.0":"10/11","6.3":"8.1","6.2":"8","6.1":"7","6.0":"Vista","5.1":"XP"}[n]||n}let s=e.match(/Mac OS X (\d+_\d+_?\d*)/);return s?s[1].replace(/_/g,"."):"Unknown"}detectDeviceBrand(){let e=navigator.userAgent.toLowerCase();return/iphone|ipad|ipod/.test(e)?"Apple":/samsung/.test(e)?"Samsung":/huawei/.test(e)?"Huawei":/xiaomi/.test(e)?"Xiaomi":/oppo/.test(e)?"Oppo":/vivo/.test(e)?"Vivo":/oneplus/.test(e)?"OnePlus":/lg/.test(e)?"LG":/htc/.test(e)?"HTC":/sony/.test(e)?"Sony":/motorola|moto/.test(e)?"Motorola":/nokia/.test(e)?"Nokia":/pixel/.test(e)?"Google":/mac/.test(e)?"Apple":/windows/.test(e)?"Microsoft":"Unknown"}detectDeviceModel(){let e=navigator.userAgent;if(!/Mobile|Android|iPhone|iPad/.test(e)){let s=this.getBrowserInfo(),n=this.detectPlatform();return`${s} on ${n}`}let t=e.match(/iPhone(\d+,\d+)/);if(t)return{"14,7":"iPhone 14","14,8":"iPhone 14 Plus","15,2":"iPhone 14 Pro","15,3":"iPhone 14 Pro Max","14,4":"iPhone 13 mini","14,5":"iPhone 13","14,2":"iPhone 13 Pro","14,3":"iPhone 13 Pro Max","13,1":"iPhone 12 mini","13,2":"iPhone 12","13,3":"iPhone 12 Pro","13,4":"iPhone 12 Pro Max"}[t[1]]||`iPhone ${t[1]}`;let i=e.match(/iPad(\d+,\d+)/);if(i)return`iPad ${i[1]}`;let r=e.match(/;\s*([^;)]+)\s*\)/);if(r&&/android/i.test(e)){let s=r[1].trim();if(s&&!s.includes("wv")&&s.length<50)return s}return"Unknown"}getBrowserInfo(){let e=navigator.userAgent.toLowerCase();if(e.includes("chrome")&&!e.includes("edg")){let t=e.match(/chrome\/(\d+)/);return t?`Chrome ${t[1]}`:"Chrome"}if(e.includes("firefox")){let t=e.match(/firefox\/(\d+)/);return t?`Firefox ${t[1]}`:"Firefox"}if(e.includes("safari")&&!e.includes("chrome")){let t=e.match(/version\/(\d+)/);return t?`Safari ${t[1]}`:"Safari"}if(e.includes("edg")){let t=e.match(/edg\/(\d+)/);return t?`Edge ${t[1]}`:"Edge"}return"Browser"}initSessionTracking(){localStorage.getItem("appfig_first_open")||(this.logEvent("first_open"),localStorage.setItem("appfig_first_open","true")),this.logEvent("session_start"),this.sessionActive=!0,this.lastActivity=Date.now(),this.setupActivityTracking(),this.resetSessionTimeout(),this.setupVisibilityTracking()}setupActivityTracking(){let e=["mousedown","mousemove","keypress","scroll","touchstart","click"],t=()=>{this.lastActivity=Date.now(),this.resetSessionTimeout()};e.forEach(i=>{document.addEventListener(i,t,{passive:!0})})}resetSessionTimeout(){this.sessionTimeout&&clearTimeout(this.sessionTimeout),this.sessionTimeout=setTimeout(()=>{this.sessionActive&&this.endSession()},this.sessionTimeoutMs)}setupVisibilityTracking(){let e=()=>{document.hidden&&this.sessionActive?this.endSession():!document.hidden&&!this.sessionActive&&(this.log("[AppFig] \u{1F4F1} App foregrounded, starting session"),this.logEvent("session_start"),this.sessionActive=!0,this.lastActivity=Date.now(),this.resetSessionTimeout())};document.addEventListener("visibilitychange",e),window.addEventListener("beforeunload",()=>{this.sessionActive&&(this.log("[AppFig] Session ended"),this.endSession())})}endSession(){this.sessionActive&&(this.logEvent("session_end"),this.sessionActive=!1,this.sessionTimeout&&(clearTimeout(this.sessionTimeout),this.sessionTimeout=null))}stopSessionTracking(){this.sessionTimeout&&(clearTimeout(this.sessionTimeout),this.sessionTimeout=null),this.sessionActive&&this.endSession()}ruleMatches(e){let{events:t=[],user_properties:i=[],device:r=[],user_properties_operator:s="AND",device_operator:n="AND"}=e.conditions||{};this.log("[AppFig] ruleMatches - Evaluating conditions:"),this.log("  - events:",JSON.stringify(t)),this.log("  - user_properties:",JSON.stringify(i)),this.log("  - device:",JSON.stringify(r));let a=this.evaluateEventsConfig(t,e.sequential);this.log("[AppFig] Events evaluation result:",a?"\u2705 PASS":"\u274C FAIL");let c=this.evaluatePropertiesWithOperator(i,[this.userProperties],s);this.log("[AppFig] User properties evaluation result:",c?"\u2705 PASS":"\u274C FAIL");let o=this.evaluatePropertiesWithOperator(r,[this.deviceProperties],n);this.log("[AppFig] Device properties evaluation result:",o?"\u2705 PASS":"\u274C FAIL");let h=a&&c&&o;return this.log("[AppFig] Final rule match result:",h?"\u2705 PASS":"\u274C FAIL"),h}evaluateEventsConfig(e,t){if(Array.isArray(e))return this.matchConditions(e,this.eventHistory,!0,t);let i=e,r=i.mode||"simple",s=i.events||[];if(s.length===0)return!0;let n=i.operator||"AND",a=i.ordering||"direct";return r==="simple"?n==="AND"?s.every(c=>this.eventHistory.some(o=>this.conditionMatches(c,o))):s.some(c=>this.eventHistory.some(o=>this.conditionMatches(c,o))):this.evaluateSequence(s,a)}evaluateSequence(e,t){if(t==="direct"){let i=-1;for(let r of e){let s=!1;for(let n=i+1;n<this.eventHistory.length;n++)if(this.conditionMatches(r,this.eventHistory[n])){i=n,s=!0;break}if(!s)return!1}return!0}else{let i=0;for(let r of e){let s=!1;for(let n=i;n<this.eventHistory.length;n++)if(this.conditionMatches(r,this.eventHistory[n])){i=n+1,s=!0;break}if(!s)return!1}return!0}}evaluatePropertiesWithOperator(e,t,i){return e.length===0?!0:i==="AND"?e.every(r=>t.some(s=>this.conditionMatches(r,s))):e.some(r=>t.some(s=>this.conditionMatches(r,s)))}matchConditions(e,t,i=!1,r=!1){if(r&&i){let s=0;for(let n of e){let a=!1;for(;s<t.length;){let c=t[s];if(this.conditionMatches(n,c)){a=!0,s++;break}s++}if(!a)return!1}return!0}else return e.every(s=>t.some(n=>this.conditionMatches(s,n)))}conditionMatches(e,t){if("name"in t){let r=e.operator||"==";if(!this.compare(r,t.name,e.key))return!1}let i=!0;if(e.param&&"params"in t&&t.params)for(let[r,s]of Object.entries(e.param)){let n=t.params[r];if(!this.compare(s.operator,n,s.value)){i=!1;break}}if(e.count){let r=e.operator||"==",s=this.eventHistory.filter(n=>"name"in n&&this.compare(r,n.name,e.key)).length;i=i&&this.compare(e.count.operator,s,e.count.value)}if(e.repeat){let r=e.operator||"==",s=this.getMaxConsecutiveOccurrences(e.key,r);i=i&&this.compare(e.repeat.operator,s,e.repeat.value)}if(e.value!==void 0&&!("name"in t)){let r=t[e.key],s=this.compare(e.value.operator,r,e.value.value);i=i&&s}if(e.within_last_days&&"timestamp"in t){let r=e.within_last_days,s=Date.now()-r*864e5;i=i&&t.timestamp>=s}return e.not&&(i=!i),i}getMaxConsecutiveOccurrences(e,t="=="){let i=0,r=0,s=[...this.eventHistory].sort((n,a)=>n.timestamp-a.timestamp);for(let n=0;n<s.length;n++){let a=s[n];this.compare(t,a.name,e)?(r++,i=Math.max(i,r)):r=0}return i}compare(e,t,i){switch(e){case"==":return t===i;case"!=":return t!==i;case">":return t>i;case"<":return t<i;case">=":return t>=i;case"<=":return t<=i;case"in":return Array.isArray(i)?i.some(r=>String(r).toLowerCase()===String(t).toLowerCase()):!1;case"not_in":return Array.isArray(i)?!i.some(r=>String(r).toLowerCase()===String(t).toLowerCase()):!0;case"contains":return typeof t=="string"&&typeof i=="string"&&t.toLowerCase().includes(i.toLowerCase());case"starts_with":return typeof t=="string"&&typeof i=="string"&&t.toLowerCase().startsWith(i.toLowerCase());case"ends_with":return typeof t=="string"&&typeof i=="string"&&t.toLowerCase().endsWith(i.toLowerCase());default:return!1}}schemaCache={events:new Set,eventParams:new Map,eventParamValues:new Map,userProperties:new Map,deviceProperties:new Map};schemaDiffBuffer={new_events:new Set,new_event_params:new Map,new_user_properties:new Map,new_device_properties:new Map};schemaUploadTimeout=null;schemaUploadCount=0;deviceId="";lastSchemaUploadTime=0;SCHEMA_UPLOAD_BATCH_SIZE=50;SCHEMA_UPLOAD_INTERVAL_MS=6e5;SCHEMA_UPLOAD_THROTTLE_MS=432e5;initSchemaDiscovery(){let e=localStorage.getItem("appfig_device_id");e?this.deviceId=e:(this.deviceId=this.generateDeviceId(),localStorage.setItem("appfig_device_id",this.deviceId)),this.loadCachedSchema();let t=localStorage.getItem("appfig_last_schema_upload");t&&(this.lastSchemaUploadTime=parseInt(t,10)),this.isInSample()||this.log("DEBUG","Schema discovery: device not in 1% sample")}generateDeviceId(){return`${Date.now()}-${Math.random().toString(36).substring(2,15)}`}isInSample(){let e=0;for(let t=0;t<this.deviceId.length;t++)e=(e<<5)-e+this.deviceId.charCodeAt(t),e=e&e;return Math.abs(e)%100<1}maskPII(e){let t=String(e);return t.includes("@")&&t.includes(".")?"[email]":t.length>50?t.substring(0,50)+"...":t.length>100?t.substring(0,100):t}trackEventSchema(e,t){if(this.schemaCache.events.has(e)||(this.schemaDiffBuffer.new_events.add(e),this.schemaCache.events.add(e)),t){let i=Object.keys(t),r=this.schemaCache.eventParams.get(e);r||(r=new Set,this.schemaCache.eventParams.set(e,r));let s=this.schemaCache.eventParamValues.get(e);s||(s=new Map,this.schemaCache.eventParamValues.set(e,s));let n=this.schemaDiffBuffer.new_event_params.get(e);n||(n={params:new Set,param_values:new Map},this.schemaDiffBuffer.new_event_params.set(e,n));for(let a of i){let c=t[a],o=this.maskPII(c);r.has(a)||(n.params.add(a),r.add(a));let h=s.get(a);if(h||(h=new Set,s.set(a,h)),!h.has(o)&&h.size<20){let u=n.param_values.get(a);u||(u=new Set,n.param_values.set(a,u)),u.add(o),h.add(o)}}}this.debounceSchemaUpload()}trackUserPropertySchema(e){for(let[t,i]of Object.entries(e)){let r=this.maskPII(i),s=this.schemaCache.userProperties.get(t);if(s||(s=new Set,this.schemaCache.userProperties.set(t,s)),!s.has(r)&&s.size<20){let n=this.schemaDiffBuffer.new_user_properties.get(t);n||(n=new Set,this.schemaDiffBuffer.new_user_properties.set(t,n)),n.add(r),s.add(r)}}this.debounceSchemaUpload()}trackDevicePropertySchema(e){for(let[t,i]of Object.entries(e)){let r=this.maskPII(i),s=this.schemaCache.deviceProperties.get(t);if(s||(s=new Set,this.schemaCache.deviceProperties.set(t,s)),!s.has(r)&&s.size<20){let n=this.schemaDiffBuffer.new_device_properties.get(t);n||(n=new Set,this.schemaDiffBuffer.new_device_properties.set(t,n)),n.add(r),s.add(r)}}this.debounceSchemaUpload()}debounceSchemaUpload(){if(!this.isInSample())return;if(Date.now()-this.lastSchemaUploadTime<this.SCHEMA_UPLOAD_THROTTLE_MS){this.log("DEBUG","Schema upload throttled (12-hour limit)");return}if(this.schemaUploadTimeout&&clearTimeout(this.schemaUploadTimeout),this.schemaUploadCount++,this.schemaUploadCount>=this.SCHEMA_UPLOAD_BATCH_SIZE){this.schemaUploadCount=0,this.uploadSchemaDiff();return}this.schemaUploadTimeout=setTimeout(()=>{this.schemaUploadCount=0,this.uploadSchemaDiff()},this.SCHEMA_UPLOAD_INTERVAL_MS)}async uploadSchemaDiff(){if(!(this.schemaDiffBuffer.new_events.size===0&&this.schemaDiffBuffer.new_event_params.size===0&&this.schemaDiffBuffer.new_user_properties.size===0&&this.schemaDiffBuffer.new_device_properties.size===0))try{let e={tenant_id:this.tenantId,env:this.env};if(this.schemaDiffBuffer.new_events.size>0&&(e.new_events=Array.from(this.schemaDiffBuffer.new_events)),this.schemaDiffBuffer.new_event_params.size>0){e.new_event_params={};for(let[r,s]of this.schemaDiffBuffer.new_event_params.entries()){e.new_event_params[r]={params:Array.from(s.params),param_values:{}};for(let[n,a]of s.param_values.entries())e.new_event_params[r].param_values[n]=Array.from(a)}}if(this.schemaDiffBuffer.new_user_properties.size>0){e.new_user_properties={};for(let[r,s]of this.schemaDiffBuffer.new_user_properties.entries())e.new_user_properties[r]=Array.from(s)}if(this.schemaDiffBuffer.new_device_properties.size>0){e.new_device_properties={};for(let[r,s]of this.schemaDiffBuffer.new_device_properties.entries())e.new_device_properties[r]=Array.from(s)}let i=await fetch("https://us-central1-appfig-dev.cloudfunctions.net/collectMeta",{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.apiKey},body:JSON.stringify(e)});i.ok?(this.log("DEBUG","Schema uploaded successfully"),this.lastSchemaUploadTime=Date.now(),localStorage.setItem("appfig_last_schema_upload",String(this.lastSchemaUploadTime)),this.schemaDiffBuffer.new_events.clear(),this.schemaDiffBuffer.new_event_params.clear(),this.schemaDiffBuffer.new_user_properties.clear(),this.schemaDiffBuffer.new_device_properties.clear(),this.saveCachedSchema()):this.log("WARN",`Schema upload failed: ${i.status}`)}catch(e){this.warn("[AppFig] Schema upload error:",e)}}loadCachedSchema(){try{let e=localStorage.getItem("appfig_schema_cache");if(e){let t=JSON.parse(e);this.schemaCache.events=new Set(t.events||[]),this.schemaCache.eventParams=new Map;for(let[i,r]of Object.entries(t.eventParams||{}))this.schemaCache.eventParams.set(i,new Set(r));this.schemaCache.eventParamValues=new Map;for(let[i,r]of Object.entries(t.eventParamValues||{})){let s=new Map;for(let[n,a]of Object.entries(r))s.set(n,new Set(a));this.schemaCache.eventParamValues.set(i,s)}this.schemaCache.userProperties=new Map;for(let[i,r]of Object.entries(t.userProperties||{}))this.schemaCache.userProperties.set(i,new Set(r));this.schemaCache.deviceProperties=new Map;for(let[i,r]of Object.entries(t.deviceProperties||{}))this.schemaCache.deviceProperties.set(i,new Set(r));this.log("[AppFig] Loaded cached schema")}}catch(e){this.warn("[AppFig] Failed to load cached schema:",e)}}saveCachedSchema(){try{let e={events:Array.from(this.schemaCache.events),eventParams:{},eventParamValues:{},userProperties:{},deviceProperties:{}};for(let[t,i]of this.schemaCache.eventParams.entries())e.eventParams[t]=Array.from(i);for(let[t,i]of this.schemaCache.eventParamValues.entries()){e.eventParamValues[t]={};for(let[r,s]of i.entries())e.eventParamValues[t][r]=Array.from(s)}for(let[t,i]of this.schemaCache.userProperties.entries())e.userProperties[t]=Array.from(i);for(let[t,i]of this.schemaCache.deviceProperties.entries())e.deviceProperties[t]=Array.from(i);localStorage.setItem("appfig_schema_cache",JSON.stringify(e)),this.log("[AppFig] Saved schema cache")}catch(e){this.warn("[AppFig] Failed to save schema cache:",e)}}},m=new l,y=m;export{y as default};
